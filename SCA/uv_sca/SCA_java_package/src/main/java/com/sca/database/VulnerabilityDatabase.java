package com.sca.database;

import com.sca.config.ConfigLoader;
import java.sql.*;
import java.util.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * 在线漏洞数据库（MySQL）
 */
public class VulnerabilityDatabase {
    private static final Logger logger = LoggerFactory.getLogger(VulnerabilityDatabase.class);
    
    private static final String DB_HOST = ConfigLoader.getDbHost();
    private static final String DB_NAME = ConfigLoader.getDbName();
    private static final String DB_USER = ConfigLoader.getDbUser();
    
    private Connection connection;
    
    /**
     * 连接到数据库
     */
    public boolean connect() {
        try {
            // 使用utf8编码，Java MySQL连接器不支持utf8mb4作为characterEncoding参数
            String url = String.format("jdbc:mysql://%s/%s?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC", 
                DB_HOST, DB_NAME);
            String password = ConfigLoader.getDbPassword();
            connection = DriverManager.getConnection(url, DB_USER, password);
            
            if (connection != null && !connection.isClosed()) {
                logger.info("[+] 成功连接到数据库 {}", DB_NAME);
                return true;
            }
        } catch (SQLException e) {
            logger.error("[!] 数据库连接失败: {}", e.getMessage());
        }
        return false;
    }
    
    /**
     * 断开数据库连接
     */
    public void disconnect() {
        if (connection != null) {
            try {
                connection.close();
                logger.info("[+] 数据库连接已关闭");
            } catch (SQLException e) {
                logger.error("[!] 关闭连接失败: {}", e.getMessage());
            }
        }
    }
    
    /**
     * 根据PURL列表查询漏洞信息
     */
    public List<Map<String, Object>> queryVulnerabilitiesByPurl(List<String> purlList) {
        if (connection == null) {
            logger.error("[!] 数据库未连接");
            return new ArrayList<>();
        }
        
        if (purlList == null || purlList.isEmpty()) {
            logger.error("[!] PURL列表为空");
            return new ArrayList<>();
        }
        
        try {
            // 第一步：查询映射表获取pk_oss_id
            String placeholders = String.join(",", Collections.nCopies(purlList.size(), "?"));
            String queryMap = String.format(
                "SELECT pk_purl, pk_oss_id FROM t_oss_id_purl_map WHERE pk_purl IN (%s)", 
                placeholders);
            
            logger.info("[+] 查询映射表，PURL数量: {}", purlList.size());
            
            List<Map<String, Object>> mappingResults = new ArrayList<>();
            try (PreparedStatement stmt = connection.prepareStatement(queryMap)) {
                for (int i = 0; i < purlList.size(); i++) {
                    stmt.setString(i + 1, purlList.get(i));
                }
                
                try (ResultSet rs = stmt.executeQuery()) {
                    while (rs.next()) {
                        Map<String, Object> map = new HashMap<>();
                        map.put("pk_purl", rs.getString("pk_purl"));
                        map.put("pk_oss_id", rs.getString("pk_oss_id"));
                        mappingResults.add(map);
                    }
                }
            }
            
            if (mappingResults.isEmpty()) {
                logger.info("[+] 未找到相关的漏洞映射");
                return new ArrayList<>();
            }
            
            logger.info("[+] 找到 {} 个漏洞映射", mappingResults.size());
            
            // 第二步：查询漏洞详情
            List<String> ossIdList = new ArrayList<>();
            for (Map<String, Object> map : mappingResults) {
                ossIdList.add((String) map.get("pk_oss_id"));
            }
            
            String placeholdersVuln = String.join(",", Collections.nCopies(ossIdList.size(), "?"));
            String queryVuln = String.format(
                "SELECT oss_id, cve_id, description, severity, cvss_score_v2, " +
                "cvss_score_v3, cvss_score_v4, source_publish_date as published_date " +
                "FROM t_origin_vulnerability WHERE oss_id IN (%s)", 
                placeholdersVuln);
            
            Map<String, Map<String, Object>> vulnMap = new HashMap<>();
            try (PreparedStatement stmt = connection.prepareStatement(queryVuln)) {
                for (int i = 0; i < ossIdList.size(); i++) {
                    stmt.setString(i + 1, ossIdList.get(i));
                }
                
                try (ResultSet rs = stmt.executeQuery()) {
                    while (rs.next()) {
                        Map<String, Object> vuln = new HashMap<>();
                        vuln.put("oss_id", rs.getString("oss_id"));
                        vuln.put("cve_id", rs.getString("cve_id"));
                        vuln.put("description", rs.getString("description"));
                        vuln.put("severity", rs.getString("severity"));
                        vuln.put("cvss_score_v2", rs.getObject("cvss_score_v2"));
                        vuln.put("cvss_score_v3", rs.getObject("cvss_score_v3"));
                        vuln.put("cvss_score_v4", rs.getObject("cvss_score_v4"));
                        java.sql.Date publishedDate = rs.getDate("published_date");
                        vuln.put("published_date", publishedDate != null ? publishedDate.toString() : null);
                        vulnMap.put(rs.getString("oss_id"), vuln);
                    }
                }
            }
            
            // 第三步：合并结果
            List<Map<String, Object>> finalResults = new ArrayList<>();
            for (Map<String, Object> mapping : mappingResults) {
                String purl = (String) mapping.get("pk_purl");
                String ossId = (String) mapping.get("pk_oss_id");
                
                Map<String, Object> vulnInfo = vulnMap.get(ossId);
                if (vulnInfo == null) {
                    continue;
                }
                
                // 解析PURL获取包信息
                Map<String, String> packageInfo = parsePurl(purl);
                
                // 确定严重程度
                Object cvssV4 = vulnInfo.get("cvss_score_v4");
                Object cvssV3 = vulnInfo.get("cvss_score_v3");
                Object cvssV2 = vulnInfo.get("cvss_score_v2");
                
                Object cvssScore = cvssV4 != null ? cvssV4 : (cvssV3 != null ? cvssV3 : cvssV2);
                String severity = determineSeverity(cvssScore);
                
                Map<String, Object> result = new HashMap<>();
                result.put("purl", purl);
                result.put("oss_id", ossId);
                result.put("cve_id", vulnInfo.get("cve_id"));
                result.put("description", vulnInfo.get("description"));
                result.put("severity", severity);
                result.put("cvss_score", cvssV3);
                result.put("published_date", vulnInfo.get("published_date"));
                result.put("package_name", packageInfo.get("name"));
                result.put("package_version", packageInfo.get("version"));
                result.put("package_type", packageInfo.get("type"));
                result.put("cvss_score_v2", cvssV2);
                result.put("cvss_score_v4", cvssV4);
                
                finalResults.add(result);
            }
            
            logger.info("[+] 找到 {} 个漏洞", finalResults.size());
            return finalResults;
            
        } catch (SQLException e) {
            logger.error("[!] 查询失败: {}", e.getMessage());
            logger.debug("查询失败详情", e);
            return new ArrayList<>();
        }
    }
    
    /**
     * 解析PURL获取包信息
     */
    private Map<String, String> parsePurl(String purl) {
        Map<String, String> info = new HashMap<>();
        info.put("type", "unknown");
        info.put("name", purl);
        info.put("version", "unknown");
        
        try {
            if (purl.startsWith("pkg:")) {
                String rest = purl.substring(4);
                String[] parts = rest.split("/");
                if (parts.length >= 2) {
                    info.put("type", parts[0]);
                    String nameVersion = parts[1];
                    if (nameVersion.contains("@")) {
                        String[] nv = nameVersion.split("@", 2);
                        info.put("name", java.net.URLDecoder.decode(nv[0], "UTF-8"));
                        info.put("version", nv[1]);
                    } else {
                        info.put("name", java.net.URLDecoder.decode(nameVersion, "UTF-8"));
                    }
                }
            }
        } catch (Exception e) {
            // 忽略解析错误
        }
        
        return info;
    }
    
    /**
     * 根据CVSS分数确定严重程度
     */
    private String determineSeverity(Object cvssScore) {
        if (cvssScore == null) {
            return "UNKNOWN";
        }
        
        try {
            double score = Double.parseDouble(cvssScore.toString());
            if (score >= 9.0) {
                return "CRITICAL";
            } else if (score >= 7.0) {
                return "HIGH";
            } else if (score >= 4.0) {
                return "MEDIUM";
            } else if (score > 0) {
                return "LOW";
            } else {
                return "NONE";
            }
        } catch (NumberFormatException e) {
            return "UNKNOWN";
        }
    }
}

